<!DOCTYPE html>
<html lang="en" xml:th="http://www.thymeleaf.org" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITLE</title>
</head>
<style>
    /* 리뷰 섹션 스타일 */
    .reviews-section {
        padding: 20px;
        font-family: Arial, sans-serif;
        border : none !important;
    }

    /* 헤더 스타일 */
    .reviews-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .reviews-header .rating {
        font-size: 24px;
        font-weight: bold;
        color: #B2D055;
    }

    .reviews-header .review-count {
        font-size: 16px;
        color: #666;
    }
    #ratingChart {
        width: 300px; /* 차트를 더 작게 만듦 */
        height: 300px;
        margin-right: 10px; /* 차트와 평점 사이에 여백 추가 */
    }

    /* 아이콘 섹션 스타일 */
    .icons {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin: 20px 0;
    }

    .icon-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 14px;
        color: #333;
        text-align: center;
    }

    .icon-item i {
        font-size: 24px;
        margin-bottom: 8px;
        color: #B2D055;
    }

    .icon-item div {
        font-size: 12px;
        line-height: 1.5;
    }

    .icon-item strong {
        font-size: 14px;
        color: #000;
        display: block;
        margin-top: 5px;
    }

    /* 구분선 */
    .review-hr {
        border: none;
        border-top: 2px solid #B2D055;
        margin-bottom: 20px;
    }

    /* 리뷰 카드 스타일 */
    .review-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;

    }

    .review-card {
        border: 1px solid #ffffff;
        border-radius: 10px;
        padding: 15px;
        background-color: #ffffff;
    }

    #reviewModal .review-card{
        width: 300px;
        height: 90px;

    }

    #reviewModal .icon-item{
        margin-top: 25px;
        width: 350px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #B2D055;

    }




    .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

  .user-id{

  }

    .review-details {
        margin-top: 10px;
    }

    .stars {
        color: #B2D055;
        font-size: 18px;
    }

    .review-date {
        display: block;
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .review-text {
        margin-top: 10px;
        font-size: 14px;
    }

    /* 더보기 버튼 스타일 */
    .load-more {
        text-align: center;
        margin-top: 20px;
    }

    .load-more button {
        padding: 10px 20px;
        border: none;
        background-color: #B2D055;
        color: #fff;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
    }

    .load-more button:hover {
        background-color: #7e9537;
    }

            .modal {
                display: none; /* 처음에는 숨겨놓음 */
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5); /* 배경 어둡게 */
                justify-content: center;
                align-items: center;
            }

            .modal-content {
                background-color: #fff;
                padding: 20px;
                border-radius: 10px;
                width: 90%; /* 너비를 90%로 변경 */
                max-width: 800px; /* 최대 너비를 800px로 변경 */
                max-height: 90%; /* 최대 높이를 80%로 설정 (옵션) */
               /* overflow-y: auto; /* 내용이 길어질 경우 스크롤 가능하게 설정 (옵션) */
    }

            .close-modal {
                text-align: right;
                font-size: 18px;
                cursor: pointer;
            }

            /* 리뷰 섹션 스타일 */
            .reviews-section {
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-family: Arial, sans-serif;
            }

            /* 모달 내부 스타일 */
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header .rating {
                font-size: 24px;
                font-weight: bold;
                color: #B2D055;
            }

            .modal-header .review-count {
                font-size: 16px;
                color: #666;
            }

            .modal-body {
                margin-top: 20px;
            }

            #modal-half-right{
                width: 350px;
                height: auto;
                float: right;
            }

            #modal-half-left{
                width: 350px;
                height: auto;
                float: left;
                align-items: flex-start;
            }

            #modal-ratingChart{
                width: 300px;  /* 자동으로 크기를 조정 */
                height: 300px; /* 자동으로 크기를 조정 */


            }


            .review-card {
                border: 1px solid #ccc;
                border-radius: 10px;
                padding: 15px;
                background-color: #ffffff;
                margin-bottom: 20px;
            }

            .review-details {
                margin-top: 10px;
            }

            .stars {
                color: #B2D055;
                font-size: 18px;
            }

            .review-date {
                display: block;
                font-size: 12px;
                color: #888;
                margin-top: 5px;
            }

            .review-text {
                margin-top: 10px;
                font-size: 14px;
            }

            .pagination {
                 display: flex;
                justify-content: center; /* 가운데 정렬 */
                 margin-top: 20px;
            }

            .page-button {
                padding: 10px 15px;
                margin: 0 5px;
                border: none;
                background-color: white;
                color: #333;
                font-size: 16px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            .page-button:hover {
                color: #B2D055;
            }


         .search-container {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 25px;
            padding: 5px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom:10px;
            width : 250px;
        }

        .search-input {
            border: none;
            outline: none;
            padding: 10px;
            border-radius: 25px;
            width: 200px;
        }



</style>
<body>
<!-- Font Awesome을 사용하려면 아래 링크 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />


<div class="reviews-section">
    <div class="reviews-section">
        <hr class="review-hr"> <!-- 여기를 위로 올림 -->
        <div class="reviews-header">
            <span class="rating">
                <i class="fas fa-star"></i> [[${replyRate.satisAvg}]]
            </span>
            <span class="review-count">리뷰 [[${replyRate.reviewCount}]]개</span>
        </div>
        <div class="icons">
            <div class="icon-item">
                <canvas id="ratingChart"></canvas>
            </div>
            <div class="icon-item">
                <i class="fas fa-bars"></i>
                <div>전체 평점(만족도)<br><strong>[[${replyRate.satisAvg}]]</strong></div>
            </div>
            <div class="icon-item">
                <i class="fas fa-stopwatch"></i>
                <div>청결도<br><strong>[[${replyRate.cleanAvg}]]</strong></div>
            </div>
            <div class="icon-item">
                <i class="fas fa-check-circle"></i>
                <div>정확도<br><strong>[[${replyRate.accuracyAvg}]]</strong></div>
            </div>
            <div class="icon-item">
                <i class="fas fa-tags"></i>
                <div>가격 대비 만족도<br><strong>[[${replyRate.scpAvg}]]</strong></div>
            </div>
        </div>
        <hr class="review-hr">
    </div>


    <div class="review-cards">
        <div class="review-card1" th:each="review:${list}" style="display:none">
            <div class="review-details">
                <div class="user-id">[[${review.id}]]</div>
                <div th:if="${review.satisfy} == 5">
                    <span class="stars">★★★★★</span>
                </div>
                <div th:if="${review.satisfy} == 4">
                    <span class="stars">★★★★</span>
                </div>
                <div th:if="${review.satisfy} == 3">
                    <span class="stars">★★★</span>
                </div>
                <div th:if="${review.satisfy} == 2">
                    <span class="stars">★★</span>
                </div>
                <div th:if="${review.satisfy} == 1">
                    <span class="stars">★</span>
                </div>
                <span class="review-date">[[${review.hiredate}]]</span>
                <div class="review-text">[[${review.revContent}]]</div>
            </div>
        </div>
    </div>

    <div class="reviews-section">
        <!-- 기존 리뷰 섹션 -->
        <div class="load-more">
            <button id="loadMoreBtn">리뷰 [[${replyRate.reviewCount}]]개 더보기</button>
        </div>
    </div>

    <!-- 모달 구조 -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="close-modal" id="closeModal">&times;</div>
            <div class="modal-header">
                <span class="rating">
                    <i class="fas fa-star"></i> [[${replyRate.satisAvg}]]
                </span>
                <span class="review-count">리뷰 [[${replyRate.reviewCount}]]개</span>
            </div>
            <hr class="review-hr">
            <div class="modal-body">
                <!-- 리뷰 목록 -->
                <div id="modal-half-left">
                    <canvas id="modal-ratingChart" width="200px" height="200px"></canvas>
                    <div class="icon-item">
                        <i class="fas fa-bars"></i>
                        <div>전체 평점(만족도)<br><strong>[[${replyRate.satisAvg}]]</strong></div>

                    </div>
                    <div class="icon-item">
                        <i class="fas fa-stopwatch"></i>
                        <div>청결도<br><strong>[[${replyRate.cleanAvg}]]</strong></div>

                    </div>
                    <div class="icon-item">
                        <i class="fas fa-check-circle"></i>
                        <div>정확도<br><strong>[[${replyRate.accuracyAvg}]]</strong></div>

                    </div>
                    <div class="icon-item">
                        <i class="fas fa-tags"></i>
                        <div>가격 대비 만족도<br><strong>[[${replyRate.scpAvg}]]</strong></div>

                    </div>
                </div>
                <div id="modal-half-right"> </div>
            </div>





            <!-- 추가 리뷰 카드들 -->
        </div>
    </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    window.onload = function(){

       const cards = document.querySelectorAll(".review-card1");

       for(let i = 0; i<6 && i<cards.length;i++){
            cards[i].style.display='block';
       }



      const ratings = {
          labels: ['5', '4', '3', '2', '1'],
          datasets: [{
              label: '별점 분포',
              data: [ [[${replyRate.count5}]], [[${replyRate.count4}]], [[${replyRate.count3}]], [[${replyRate.count2}]], [[${replyRate.count1}]] ],
              backgroundColor: 'rgba(118, 185, 0, 0.5)',
              borderColor: 'rgba(118, 185, 0, 1)',
              borderWidth: 0.1
          }]
      };


      const options = {
      indexAxis: 'y',
      maintainAspectRatio: true, // 차트가 부모 컨테이너에 맞춰 크기를 조정
      aspectRatio: 2, // 비율을 설정하여 차트의 크기를 조절 (너비에 비해 높이를 작게)
      scales: {
          x: {
              beginAtZero: true
          }
      }
   };

      // 차트를 그리는 함수
      const ctx = document.getElementById('ratingChart').getContext('2d');
      const ratingChart = new Chart(ctx, {
          type: 'bar',
          data: ratings,
          options: options
      });

      const ctx1 = document.getElementById('modal-ratingChart').getContext('2d');
      const ratingChart1 = new Chart(ctx1, {
          type: 'bar',
          data: ratings,
          options: options
      });
      const modal = document.getElementById('reviewModal');
         const openBtn = document.getElementById('loadMoreBtn');
         const closeModal = document.getElementById('closeModal');


         openBtn.onclick = function() {
             modal.style.display = 'flex';
         }


         closeModal.onclick = function() {
             modal.style.display = 'none';
         }


         window.onclick = function(event) {
             if (event.target == modal) {
                 modal.style.display = 'none';
             }
         }

         let search =  document.getElementsByClassName("search-input");
         let buttonNum =1;
         let searchValue;

         let rv =  document.getElementById("modal-half-right")
          let xhr = new XMLHttpRequest();
               xhr.onload = function(){
                  if(xhr.status == 200) {
                      let obj =  xhr.responseText;
                      let jsonObj  =  JSON.parse(obj);

                       let html = "";

                       html +='<div class="search-container"><input id="searchBar" type="text" placeholder="후기 검색" class="search-input" name="search"></div>';
                       jsonObj.dto.forEach(function(list){
                            html += '<div class="review-card">'
                            html += '<div class="user-info">'+list.id+'</div>';
                            if(list.satisfy == 5) {
                                html += '<span class="stars">★★★★★</span>';
                            }
                            if(list.satisfy == 4) {
                                html += '<span class="stars">★★★★</span>';
                            }
                            if(list.satisfy == 3) {
                                html += '<span class="stars">★★★</span>';
                            }
                            if(list.satisfy == 2){
                                html += '<span class="stars">★★</span>';
                            }
                            if(list.satisfy == 1){
                                html += '<span class="stars">★</span>';
                            }
                            html += '<span class="review-date">'+list.hiredate+'</span>';
                            html += '<div class="review-text">'+list.revContent+'</div>';
                            html += '</div>';

                       });
                            html += '<div class="pagination">';
                           if(jsonObj.pdto.prev){
                            html += '<button class="page-button prev">prev</button>';
                            }
                           for(let i=jsonObj.pdto.startPage;i<=jsonObj.pdto.endPage;i++){
                             if(jsonObj.pdto.currentPage == i){
                                html +='<button class="page-button" style="color: #7ca305">'+i+'</button>';
                             }else{
                                 html+='<button class="page-button">'+i+'</button>';
                             }
                           }


                            if(jsonObj.pdto.next){
                             html += '<button class="page-button next">next</button>';
                            }
                            html += '</div>'

                        rv.innerHTML = html;

                         buttons = document.getElementsByClassName("page-button");
                          for(let i=0;i<buttons.length;i++){
                            buttons[i].addEventListener("click", function(){
                             buttonNum = this.textContent;


                             if(buttonNum == 'prev'){
                                buttonNum = jsonObj.pdto.startPage-1;

                             }else if(buttonNum == 'next'){
                                buttonNum = jsonObj.pdto.endPage+1;

                             }
                             if(searchValue == undefined || searchValue ==''){
                                xhr.open('POST','/page/'+buttonNum+'/'+[[${param.accomNum}]],true);
                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
                                xhr.send("");
                                }else{
                                 xhr.open('POST', '/search/'+buttonNum+'/'+[[${param.accomNum}]]+'/'+searchValue, true);
                                 xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
                                 xhr.send("");
                                }
                            });
                        }

                     search[0].addEventListener('keydown',function(e){
                        if(e.key == 'Enter'){
                            buttonNum = 1;
                            searchValue = search[0].value;

                            if(searchValue == undefined || searchValue ==''){
                                xhr.open('POST','/page/'+buttonNum+'/'+[[${param.accomNum}]],true);
                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
                                xhr.send("");

                            }else{
                                xhr.open('POST', '/search/'+buttonNum+'/'+[[${param.accomNum}]]+'/'+searchValue, true);
                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
                                xhr.send("");
                            }
                         }
                  });

               }
           };

            xhr.open('POST','/page/'+buttonNum+'/'+[[${param.accomNum}]],true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
            xhr.send("");
   };

</script>

</body>

</html>